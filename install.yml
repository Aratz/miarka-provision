---

- name: Deploy miarka software
  hosts: deploy
  connection: local

  # These three variables needs to be overriden when calling ansible-playbook.
  #
  # Call with e.g. "ansible-playbook install.yml -e deployment_environment=staging -e deployment_version=foo".
  # If devel then the version will always be set to USERNAME_BRANCHNAME.
  # If staging or production then the playbook will halt if the folder version already exists.
  # I.e. the user will then manually have to remove the directory, OR add "-e deployment_override=true"
  # to deploy into an already existing folder.
  #
  # /vulpes/ngi/production/<latest|current> will link to /vulpes/ngi/production/<github release>
  # /vulpes/ngi/staging/ will contain a folder wild-wild-west which will be world writeable ON THE RECIEVING end. I.e. the
  # sync script will change the permissions? This is to make sure that not everyone that is able to login to miarka3 can
  # upload data into the cluster.

  pre_tasks:
    - include: tasks/set-paths.yml
      tags: always
    - include: tasks/pre-install.yml
      tags: always

  environment:
    "{{ tools_path }}"

  roles:
    - { role: ngi_pipeline, tags: ngi_pipeline }
    - { role: func_accounts, tags: func_accounts }
    - { role: nextflow, tags: nextflow }
    - { role: tarzan, tags: tarzan }
    - { role: taca, tags: taca }
    - { role: ngi_reports, tags: ngi_reports }
    - { role: multiqc, tags: multiqc }
    - { role: arteria-staging, tags: arteria-staging }
    - { role: arteria-checksum-ws, tags: arteria-checksum }
    - { role: arteria-delivery-ws, tags: arteria-delivery }
    - { role: standalone_scripts, tags: standalone_scripts }
    - { role: ugc, tags: ugc }
    - { role: misc-tools, tags: misc-tools }
    - { role: archive-upload-ws, tags: archive-upload }
    - { role: nf-core, tags: nf-core }

  post_tasks:
    - include: tasks/post-install.yml
      tags: always
